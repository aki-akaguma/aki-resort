# Requirements for aki-resort

## 1. Overview

`aki-resort` is a command-line utility written in Rust that sorts lines of text from standard input or files. It allows for complex sorting logic by letting users specify a portion of each line as the sorting key using regular expressions. The tool is designed for performance, utilizing parallel processing for sorting operations.

## 2. Functional Requirements

### 2.1. Core Functionality
- **Input Source:** The application must accept text input from standard input (stdin).
- **Sorting:** The primary function is to sort the incoming lines of text and print the result to standard output (stdout).
- **Sort Key:** By default, the entire line is used for sorting.
- **Regex-based Key Selection:** Users must be able to specify a regular expression (`-e, --exp`) to select a specific part of the line as the sorting key. The first capture group of the regex is used as the key; if no capture group exists, the entire match is used.

### 2.2. Sorting Modes
The application must support different sorting algorithms specified via the `--according-to` option:
- **`string` (default):** Standard lexicographical/UTF-8 string comparison.
- **`numeric`:** Interprets the sort key as a floating-point number and sorts accordingly.
- **`version`:** Interprets the sort key as a semantic version string (e.g., `1.10.2`) and sorts correctly.
- **`month`:** Interprets the sort key as a month name (e.g., "Jan", "February") and sorts chronologically.
- **`time`:** Interprets the sort key as a time string (e.g., `HH:MM:SS`) and sorts accordingly.

### 2.3. Command-Line Options
- **`-r, --reverse`:** Reverses the sorting order.
- **`-u, --unique`:** Outputs only the first line among a set of lines that are considered equal.
- **`-h, --head <num>`:** Excludes the first `<num>` lines from the sorting process, treating them as a fixed header.
- **`-t, --tail <num>`:** Excludes the last `<num>` lines from the sorting process, treating them as a fixed footer.
- **`--color <when>`:** Highlights the matched sort key in the output. `<when>` can be `always`, `never`, or `auto`.
- **`--max-buffer <size>`:** Sets a maximum buffer size for input data (e.g., `8M`) to prevent excessive memory usage.
- **`-H, --help`:** Displays a detailed help message.
- **`-V, --version`:** Shows version and build information.

### 2.4. Error Handling
- The application must handle I/O errors gracefully (e.g., broken pipes).
- It must provide clear error messages for invalid command-line arguments or regex parsing errors.
- If input size exceeds the `--max-buffer` limit, it must exit with an error.

## 3. Non-Functional Requirements

- **Performance:** The application should be performant and capable of handling large volumes of text. It leverages parallel processing (via the Rayon crate) to speed up sorting.
- **Memory Management:** The application should be mindful of memory usage, providing an option to limit buffer size.
- **Portability:** As a Rust application, it should be compilable and runnable on major platforms (Linux, macOS, Windows).

## 4. Key Dependencies

The application is built upon several key external crates:
- `anyhow`: For flexible and easy error handling.
- `regex`: For the regular expression engine.
- `rayon`: For data parallelism to accelerate sorting.
- `semver`: For parsing and comparing semantic version numbers.
- `flood-tide`: For command-line argument parsing.
- `atty`: To detect if the output is a TTY for smart color defaults.
