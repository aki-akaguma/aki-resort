# Design Document: aki-resort

## 1. Architecture Overview

The `aki-resort` application follows a modular, library-first design. The core logic is encapsulated in a library crate (`libaki_resort`), which is then consumed by a thin binary executable (`aki-resort`). This promotes code reuse and testability.

The application's data flow is as follows:
1.  **Entry Point (`main.rs`):** The `main` function captures command-line arguments and initializes a `RunnelIoe` object to manage standard input, output, and error streams.
2.  **Library Call (`lib.rs`):** `main` calls the `libaki_resort::execute` function, passing the arguments and I/O streams.
3.  **Configuration (`conf/`):** `execute` first calls `conf::parse_cmdopts` to parse the arguments into a structured `CmdOptConf` configuration object.
4.  **Execution (`run.rs`):** The `CmdOptConf` object is passed to `run::run`, which contains the main application logic.
5.  **Sorting (`sort/`):** `run::run` selects a specific sorting strategy based on the configuration. It reads lines from the input stream, extracts sort keys, and pushes them into a chosen sorter object that implements the `SortLinesBuffer` trait.
6.  **Output:** Once all lines are processed, the sorted results are retrieved from the sorter object and printed to the output stream.

Parallelism is achieved within the sorting modules using the `rayon` crate to significantly speed up the sorting of large datasets.

## 2. Module Design

### `main.rs`
- **Responsibility:** The application's main entry point.
- **Implementation:** It captures environment arguments, sets up the `RunnelIoe` streams, invokes the `libaki_resort::execute` function, and handles top-level errors by printing them to stderr and exiting with a non-zero status code.

### `lib.rs`
- **Responsibility:** A public library interface for the core application logic.
- **Implementation:** Provides the `execute` function that orchestrates the parsing of configuration and the execution of the main run logic. This separation makes the core logic testable and reusable.

### `conf/` Module
- **Responsibility:** Handles all aspects of configuration.
- **Implementation:**
    - `parse.rs`: Uses the `flood-tide` crate to define and parse all command-line flags and arguments. It is also responsible for generating the `--help` and `--version` messages.
    - `cmd.rs`: Defines the `CmdOptConf` struct, which is a strongly-typed representation of all possible command-line options.
    - `env.rs`: Defines `EnvConf` for handling settings passed via environment variables (e.g., `AKI_RESORT_COLOR_SEQ_ST`).

### `run.rs` Module
- **Responsibility:** Contains the primary control flow and data processing logic.
- **Implementation:**
    - The `run` function initializes the `Regex` object from the user-provided expression.
    - The `run_0` function acts as a dispatcher, selecting the concrete `SortLinesBuffer` implementation (e.g., `SortLinesBufferNumeric`, `SortLinesBufferVersion`) based on the `opt_according_to` field in the configuration.
    - The `lines_loop` function is the main loop. It reads lines from stdin, manages `--head` and `--tail` buffers (lines to exclude from sorting), uses the regex to identify the sort key within each line, and pushes the line and its key into the chosen sorter.
    - After sorting, it handles printing the results, including logic for the `--unique` and `--color` options.

### `sort/` Module
- **Responsibility:** Implements all sorting strategies.
- **Implementation:**
    - `mod.rs`: Defines the `SortLinesBuffer` trait, which abstracts the sorting behavior with `push_line` and `into_sorted_vec` methods. It also defines `KeyLine` and `KeyColumns` to link a sort key to its original line.
    - Each submodule (`numeric.rs`, `version.rs`, etc.) provides a struct that implements the `SortLinesBuffer` trait. Inside, each implementation parses the string key into a comparable type (e.g., `f64`, `semver::Version`) and uses `rayon::par_sort_by` to perform an efficient, parallel sort.

### `util/` Module
- **Responsibility:** Provides various helper functions and types.
- **Implementation:** Contains parsers for complex options (e.g., `opt_max_buffer_size`), custom enums for options (`OptColorWhen`), and error handling helpers (`err.rs`).

## 3. Acceptance Criteria Mapping

This section maps each acceptance criterion to its implementation in the codebase.

- **AC1 (Read from stdin):** Implemented in `run.rs` within `lines_loop` via the `sioe.pg_in().lines()` iterator.
- **AC2 (Sort & Print):** The entire `run.rs` and `sort/` modules work together to fulfill this. `run.rs` orchestrates, `sort/` performs the sort, and `run.rs` prints the final vector.
- **AC3 (Default Key):** In `run.rs`, if `conf.opt_exp` is empty, the `re` variable is `None`. The `lines_loop` function then uses the full line length (`0` to `line_len`) for the `KeyColumns`.
- **AC4 & AC5 (Regex Key):** In `run.rs`'s `lines_loop`, `re.captures()` is used. The code checks for capture group 1 (`caps.get(1)`) and falls back to the full match (`caps.get(0)`).
- **AC6-AC10 (Sorting Modes):** The `run_0` function in `run.rs` is a `match` statement that dispatches to the correct `SortLinesBuffer` implementation (`SortLinesBufferString`, `SortLinesBufferNumeric`, etc.) based on the `conf.opt_according_to` value.
- **AC11 (Reverse):** The `flg_reverse` boolean is passed to the constructor of the chosen `SortLinesBuffer`. Each sorting implementation uses this flag to call `.reverse()` on the final `Ordering` if true.
- **AC12 (Unique):** Implemented in `run.rs`. After sorting, if `conf.flg_unique` is true, the code iterates through the sorted results and only prints a line if it's different from the previous line.
- **AC13 (Head):** In `run.rs`'s `lines_loop`, an initial block checks `if result_buf_lines.len() < n` and adds the first `n` lines directly to the final result buffer without sending them to the sorter.
- **AC14 (Tail):** In `run.rs`'s `lines_loop`, after reading all lines, the last `n` lines are split off from the main buffer using `buf_lines.split_off(at)` before the main buffer is sorted.
- **AC15 (Color):** In `run.rs`, after sorting, if `color_is_alyways` is true, the code manually reconstructs the output string, injecting ANSI color codes around the key's start and end positions (`key_line.key.st`, `key_line.key.ed`).
- **AC16 (Help):** In `conf/parse.rs`, if the `-H` or `--help` flag is found, `is_help` is set to true, causing `parse_cmdopts` to return an `Err` containing the help message, which is then printed by `lib.rs`.
- **AC17 (Version):** Implemented identically to the help flag, but for `-V` or `--version`.
- **AC18 (Max Buffer):** In `run.rs`'s `lines_loop`, the current buffer size `curr_sz` is tracked. The `conf.opt_max_buffer.is_ok(curr_sz)` check validates it on each line read, returning an error if the limit is exceeded.
